<?xml version="1.0" encoding="utf-8"?>

<effect>
  <include name="PostProcess.xml"/>
  <include name="CommonState.xml"/>
  
  <variable type='Texture2D' name='heightTex'/>

  <variable type='cbuffer' name='cb_heightToBump'>
    <variable type='float4' name='texSize'/>
    <variable type='float' name='scale'/>
  </variable>

  <shader>
    <![CDATA[

float4 HeightToBumpPS(PostProcessVSOut vsOut) : SV_TARGET
{
	float hc = heightTex.SampleLevel(samplerLinear, vsOut.tex, 0).r;
  
  float dhx = 
  heightTex.SampleLevel(samplerLinear, vsOut.tex + float2(texSize.z, 0.0f), 0).r - 
  heightTex.SampleLevel(samplerLinear, vsOut.tex - float2(texSize.z, 0.0f), 0).r;
  
  float dhy = 
  heightTex.SampleLevel(samplerLinear, vsOut.tex + float2(0.0f, texSize.w), 0).r -
  heightTex.SampleLevel(samplerLinear, vsOut.tex - float2(0.0f, texSize.w), 0).r;
  
  float dhdx = dhx * scale;
	float dhdy = dhy * scale;
  
	float3 s = float3(1.0f, 0.0f, dhdx);
  float3 t = float3(0.0f, 1.0f, dhdy);
  
  float3 n = cross(s, t);
  n = normalize(n);
  n = (n + 1.0f) * 0.5f;
  
	return float4(n, hc);
}
    ]]>
  </shader>
  
  <technique name='HeightToBump'>
    <pass>
      <state value='disableDepth'/>
      <vs entry='PostProcessVS'/>
      <ps entry='HeightToBumpPS'/>
    </pass>
  </technique>
  
</effect>